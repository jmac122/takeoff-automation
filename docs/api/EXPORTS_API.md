# Exports API Reference

## Overview

The Exports API manages asynchronous export job creation, status tracking, and file download for project takeoff data. Exports are generated by Celery workers and stored in MinIO for secure download via presigned URLs.

## Endpoints

### Start Export

```
POST /projects/{project_id}/export
```

Start an asynchronous export job. Returns immediately with a task ID for progress tracking.

**Status**: `202 Accepted`

**Path Parameters**:
| Parameter | Type | Description |
|---|---|---|
| `project_id` | UUID | Project identifier |

**Request Body**:
```json
{
  "format": "excel",
  "options": {}
}
```

| Field | Type | Required | Description |
|---|---|---|---|
| `format` | string | Yes | Export format: `"csv"`, `"excel"`, `"pdf"`, `"ost"` |
| `options` | object | No | Format-specific options |

**Response** `202 Accepted`:
```json
{
  "task_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "export_id": "f0e1d2c3-b4a5-6789-0fed-cba987654321",
  "message": "Export job started for format: excel"
}
```

**Error Responses**:
| Status | Description |
|---|---|
| `404` | Project not found |

**Notes**:
- Creates an `ExportJob` record with status `"pending"`
- Creates a `TaskRecord` for progress tracking
- Queues a Celery background task to generate the export
- Poll `GET /tasks/{task_id}/status` for progress

---

### Get Export

```
GET /exports/{export_id}
```

Get the current status and download URL for an export job.

**Path Parameters**:
| Parameter | Type | Description |
|---|---|---|
| `export_id` | UUID | Export job identifier |

**Response** `200 OK`:
```json
{
  "id": "f0e1d2c3-b4a5-6789-0fed-cba987654321",
  "project_id": "550e8400-e29b-41d4-a716-446655440000",
  "format": "excel",
  "status": "completed",
  "file_key": "exports/550e8400.../f0e1d2c3....xlsx",
  "file_size": 45321,
  "error_message": null,
  "download_url": "https://minio.example.com/...?X-Amz-Signature=...",
  "options": {},
  "started_at": "2026-02-01T10:00:01Z",
  "completed_at": "2026-02-01T10:00:05Z",
  "created_at": "2026-02-01T10:00:00Z",
  "updated_at": "2026-02-01T10:00:05Z"
}
```

**Notes**:
- `download_url` is only populated when `status = "completed"` and `file_key` exists
- Presigned URL expires after 3600 seconds (1 hour)
- If URL generation fails, `download_url` is `null` (graceful degradation)

**Error Responses**:
| Status | Description |
|---|---|
| `404` | Export not found |

---

### List Project Exports

```
GET /projects/{project_id}/exports
```

List all export jobs for a project, ordered by newest first.

**Path Parameters**:
| Parameter | Type | Description |
|---|---|---|
| `project_id` | UUID | Project identifier |

**Response** `200 OK`:
```json
{
  "exports": [
    {
      "id": "uuid",
      "project_id": "uuid",
      "format": "excel",
      "status": "completed",
      "file_key": "exports/.../file.xlsx",
      "file_size": 45321,
      "error_message": null,
      "download_url": "https://...",
      "options": {},
      "started_at": "2026-02-01T10:00:01Z",
      "completed_at": "2026-02-01T10:00:05Z",
      "created_at": "2026-02-01T10:00:00Z",
      "updated_at": "2026-02-01T10:00:05Z"
    }
  ],
  "total": 5
}
```

**Error Responses**:
| Status | Description |
|---|---|
| `404` | Project not found |

---

### Delete Export

```
DELETE /exports/{export_id}
```

Delete an export job and its associated file from storage.

**Status**: `204 No Content`

**Path Parameters**:
| Parameter | Type | Description |
|---|---|---|
| `export_id` | UUID | Export job identifier |

**Notes**:
- Deletes the `ExportJob` database record
- Deletes the associated file from MinIO storage (if exists)
- File deletion failures are logged but don't prevent record deletion

**Error Responses**:
| Status | Description |
|---|---|
| `404` | Export not found |

## Response Schemas

### ExportJobResponse

| Field | Type | Description |
|---|---|---|
| `id` | UUID | Export job ID |
| `project_id` | UUID | Parent project ID |
| `format` | string | Export format (`csv`, `excel`, `pdf`, `ost`) |
| `status` | string | Job status: `pending`, `processing`, `completed`, `failed` |
| `file_key` | string? | MinIO storage key for the generated file |
| `file_size` | int? | File size in bytes |
| `error_message` | string? | Error details if `status = "failed"` |
| `download_url` | string? | Presigned download URL (only when completed) |
| `options` | object? | Format-specific options used |
| `started_at` | datetime? | When processing began |
| `completed_at` | datetime? | When processing finished |
| `created_at` | datetime | Record creation time |
| `updated_at` | datetime | Last update time |

### Export Status Lifecycle

```
pending → processing → completed
                    → failed
```

## Usage Flow

```
1. POST /projects/{id}/export { format: "excel" }
   → 202 { task_id, export_id }

2. Poll: GET /tasks/{task_id}/status
   → { status: "processing", progress: 50 }
   → { status: "completed" }

3. GET /exports/{export_id}
   → { status: "completed", download_url: "https://..." }

4. Download file via presigned URL
```
