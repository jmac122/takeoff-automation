/**
 * Dashboard - Main application interface
 * 
 * Refactored to follow SOLID, DRY, KISS principles:
 * - Extracted components for single responsibilities
 * - Reusable UI components from shadcn/ui
 * - Clear separation of concerns
 */

import { useState } from "react";
import { useQuery, useMutation } from "@tanstack/react-query";
import axios from "axios";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { DocumentUploader } from "../components/document/DocumentUploader";
import { HealthStatusBadge } from "../components/dashboard/HealthStatusBadge";
import { PageInfoCard } from "../components/dashboard/PageInfoCard";
import { LLMProviderSelector } from "../components/LLMProviderSelector";
import { PageBrowser } from "../components/document/PageBrowser";

// Types
interface HealthResponse {
    status: string;
}

interface PageData {
    id: string;
    document_id: string;
    page_number: number;
    sheet_number: string | null;
    classification: string | null;
    concrete_relevance?: string | null;
    thumbnail_url: string | null;
    image_url: string | null;
    status: string;
}

// Constants
const DEMO_PROJECT_ID = "fb5df285-615c-40e7-875c-4639c9ea0706";

export default function Dashboard() {
    const [uploadedDocumentId, setUploadedDocumentId] = useState<string | null>(null);
    const [selectedPageId, setSelectedPageId] = useState<string | null>(null);
    const [classificationProvider, setClassificationProvider] = useState<string | undefined>(undefined);

    // API: Health check
    const { data: healthData, isLoading: healthLoading, error: healthError } = useQuery({
        queryKey: ["health"],
        queryFn: async (): Promise<HealthResponse> => {
            const response = await axios.get("/api/v1/health");
            return response.data;
        },
    });

    // API: Fetch pages for document
    const { data: pagesData, refetch: refetchPages } = useQuery({
        queryKey: ["document-pages", uploadedDocumentId],
        queryFn: async () => {
            if (!uploadedDocumentId) return null;
            const response = await axios.get(`/api/v1/documents/${uploadedDocumentId}/pages`);
            return response.data as { pages: PageData[]; total: number };
        },
        enabled: !!uploadedDocumentId,
        refetchInterval: uploadedDocumentId ? 3000 : false,
    });

    // API: Classify all pages
    const classifyDocumentMutation = useMutation({
        mutationFn: async (documentId: string) => {
            const response = await axios.post(`/api/v1/documents/${documentId}/classify`, {
                provider: classificationProvider,
            });
            return response.data;
        },
        onSuccess: () => {
            setTimeout(() => refetchPages(), 2000);
        },
    });

    // Loading state
    if (healthLoading) {
        return (
            <div className="flex items-center justify-center min-h-screen">
                <p className="text-muted-foreground">Loading...</p>
            </div>
        );
    }

    // Error state
    if (healthError) {
        return (
            <div className="container mx-auto py-8">
                <Alert variant="destructive">
                    <AlertDescription>Error loading dashboard. Please refresh the page.</AlertDescription>
                </Alert>
            </div>
        );
    }

    return (
        <div className="container mx-auto py-6 space-y-6">
            {/* Header Card */}
            <Card>
                <CardHeader className="text-center">
                    <CardTitle className="text-2xl">ForgeX Takeoffs</CardTitle>
                    <CardDescription>
                        Upload construction plans and let AI generate accurate takeoffs
                    </CardDescription>
                    <div className="flex justify-center mt-4">
                        <HealthStatusBadge status={healthData?.status || "Unknown"} />
                    </div>
                </CardHeader>
                <CardContent className="space-y-4">
                    <div>
                        <h3 className="text-lg font-medium mb-4">
                            Upload Plans (Phase 2A - Page Classification Test)
                        </h3>
                        <DocumentUploader
                            projectId={DEMO_PROJECT_ID}
                            onUploadComplete={(documentId) => {
                                console.log("Document uploaded:", documentId);
                                setUploadedDocumentId(documentId);
                            }}
                        />
                    </div>
                </CardContent>
            </Card>

            {/* Phase 2A Info */}
            <Alert>
                <AlertDescription>
                    <p className="font-semibold">Phase 2A Testing Mode - Page Classification</p>
                    <p className="text-sm mt-1">
                        Using project: <code className="bg-muted px-2 py-1 rounded">Test Project</code>
                    </p>
                    <p className="text-xs text-muted-foreground mt-2">
                        Upload a PDF â†’ Click "Classify All Pages" to test different LLMs!
                    </p>
                </AlertDescription>
            </Alert>

            {/* LLM Provider Settings */}
            <Card>
                <CardHeader>
                    <CardTitle>LLM Provider Settings</CardTitle>
                    <CardDescription>
                        Select which AI provider to use for classification
                    </CardDescription>
                </CardHeader>
                <CardContent>
                    <LLMProviderSelector
                        value={classificationProvider}
                        onChange={setClassificationProvider}
                        label="Classification Provider"
                    />
                </CardContent>
            </Card>

            {/* Document Pages */}
            {uploadedDocumentId && (
                <Card>
                    <CardHeader>
                        <div className="flex items-center justify-between">
                            <div>
                                <CardTitle>Document Pages ({pagesData?.total || 0})</CardTitle>
                                <CardDescription>Click a page to view classification details</CardDescription>
                            </div>
                            <div className="flex gap-2">
                                <Button variant="outline" onClick={() => refetchPages()}>
                                    Refresh
                                </Button>
                                <Button
                                    onClick={() => classifyDocumentMutation.mutate(uploadedDocumentId)}
                                    disabled={classifyDocumentMutation.isPending}
                                >
                                    {classifyDocumentMutation.isPending ? "Starting..." : "Classify All Pages"}
                                </Button>
                            </div>
                        </div>
                    </CardHeader>
                    <CardContent>
                        {classifyDocumentMutation.isSuccess && (
                            <Alert className="mb-4">
                                <AlertDescription>
                                    Classification started! Results will appear as pages are processed.
                                </AlertDescription>
                            </Alert>
                        )}

                        {/* Pages Grid */}
                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                            {pagesData?.pages.map((page) => (
                                <PageInfoCard
                                    key={page.id}
                                    page={page}
                                    isSelected={selectedPageId === page.id}
                                    onSelect={() => setSelectedPageId(page.id)}
                                />
                            ))}
                        </div>

                        {pagesData?.pages.length === 0 && (
                            <p className="text-center text-muted-foreground py-8">
                                No pages found. Document may still be processing.
                            </p>
                        )}
                    </CardContent>
                </Card>
            )}

            {/* Selected Page Details */}
            {selectedPageId && uploadedDocumentId && (
                <Card>
                    <CardHeader>
                        <CardTitle>Classification Details</CardTitle>
                        <CardDescription>Detailed view for selected page</CardDescription>
                    </CardHeader>
                    <CardContent>
                        <PageBrowser
                            documentId={uploadedDocumentId}
                            onPageSelect={(pageId) => setSelectedPageId(pageId)}
                        />
                    </CardContent>
                </Card>
            )}

            {/* Instructions */}
            {!uploadedDocumentId && (
                <Card>
                    <CardHeader>
                        <CardTitle>How to Test Phase 2A</CardTitle>
                    </CardHeader>
                    <CardContent>
                        <ol className="space-y-2 text-sm">
                            <li className="flex items-start gap-2">
                                <span className="flex-shrink-0 w-6 h-6 bg-primary/10 text-primary rounded-full flex items-center justify-center text-xs font-bold">
                                    1
                                </span>
                                <span>Upload a PDF construction plan document above</span>
                            </li>
                            <li className="flex items-start gap-2">
                                <span className="flex-shrink-0 w-6 h-6 bg-primary/10 text-primary rounded-full flex items-center justify-center text-xs font-bold">
                                    2
                                </span>
                                <span>Wait for document processing to complete</span>
                            </li>
                            <li className="flex items-start gap-2">
                                <span className="flex-shrink-0 w-6 h-6 bg-primary/10 text-primary rounded-full flex items-center justify-center text-xs font-bold">
                                    3
                                </span>
                                <span>Click "Classify All Pages" to run AI classification</span>
                            </li>
                            <li className="flex items-start gap-2">
                                <span className="flex-shrink-0 w-6 h-6 bg-primary/10 text-primary rounded-full flex items-center justify-center text-xs font-bold">
                                    4
                                </span>
                                <span>Click on any page to see detailed classification results</span>
                            </li>
                        </ol>
                    </CardContent>
                </Card>
            )}
        </div>
    );
}
